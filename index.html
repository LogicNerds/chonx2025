<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Chonx: 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Press Start 2P';
            background: #000;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        /* Force landscape orientation - rotate everything if portrait */
        @media screen and (orientation: portrait) {
            body {
                transform: rotate(90deg);
                transform-origin: left top;
                width: 100vh;
                height: 100vw;
                overflow-x: hidden;
                position: fixed;
                top: 100%;
                left: 0;
            }
        }

        #gameContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            z-index: 1;
        }

        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            pointer-events: none;
        }

        /* Title Screen Overlay */
        #titleScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 60px;
        }

        #titleScreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 0, 0.03) 0px,
                rgba(0, 255, 0, 0.03) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1;
        }

        #titleScreen.hidden {
            display: none;
        }

        #logoContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            margin-bottom: 40px;
        }

        #logo {
            max-width: 60%;
            max-height: 50vh;
            image-rendering: pixelated;
            display: block;
        }

        #startButton {
            font-family: 'Press Start 2P';
            font-size: 14px;
            padding: 15px 30px;
            background: #000;
            color: #00ff00;
            border: 4px solid #00ff00;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 
                inset 0 0 20px rgba(0, 255, 0, 0.3),
                0 0 20px #00ff00,
                0 0 40px #00ff00;
            transition: all 0.1s;
            position: relative;
            z-index: 2;
            letter-spacing: 2px;
        }

        #startButton:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.5),
                0 0 30px #00ff00,
                0 0 60px #00ff00;
        }

        #startButton:active {
            transform: scale(0.98);
            box-shadow: 
                inset 0 0 40px rgba(0, 255, 0, 0.8),
                0 0 15px #00ff00;
        }

        #legalFooter {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            padding: 12px;
            text-align: center;
            font-size: 7px;
            line-height: 1.6;
            color: #666;
            border-top: 2px solid #00ff00;
            z-index: 2;
            font-family: 'Press Start 2P';
        }

        #legalFooter p {
            margin: 2px 0;
        }

        /* Left Control Panel */
        #leftControls {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 180px;
            height: 100%;
            max-height: 375px;
            background: rgba(0, 0, 0, 0.9);
            border-right: 3px solid #00ff00;
            z-index: 50;
            display: none;
        }

        #leftControls.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Right Control Panel */
        #rightControls {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 180px;
            height: 100%;
            max-height: 375px;
            background: rgba(0, 0, 0, 0.9);
            border-left: 3px solid #00ff00;
            z-index: 50;
            display: none;
        }

        #rightControls.active {
            display: block;
        }

        .dpad {
            position: relative;
            width: 110px;
            height: 110px;
        }

        .dpad-btn {
            position: absolute;
            width: 36px;
            height: 36px;
            background: #000;
            border: 3px solid #00ff00;
            color: #00ff00;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: none;
            box-shadow: inset 0 0 10px #00ff00, 0 0 10px #00ff00;
            image-rendering: pixelated;
        }

        .dpad-btn:active {
            background: #00ff00;
            color: #000;
            box-shadow: inset 0 0 20px #000, 0 0 20px #00ff00;
        }

        #btnLeft { left: 0; top: 37px; }
        #btnRight { right: 0; top: 37px; }
        #btnUp { left: 37px; top: 0; }
        #btnDown { left: 37px; bottom: 0; }

        /* Fire Dial - Bottom Right */
        #fireDial {
            position: absolute;
            right: 35px;
            bottom: 30px;
            width: 110px;
            height: 110px;
            background: radial-gradient(circle, rgba(0, 255, 0, 0.1) 0%, rgba(0, 0, 0, 0.9) 70%);
            border: 3px solid #00ff00;
            border-radius: 50%;
            box-shadow: 
                inset 0 0 20px rgba(0, 255, 0, 0.3),
                0 0 15px #00ff00;
            cursor: crosshair;
            user-select: none;
            touch-action: none;
        }

        #fireDial::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background: 
                linear-gradient(0deg, transparent 49%, #00ff00 49%, #00ff00 51%, transparent 51%),
                linear-gradient(90deg, transparent 49%, #00ff00 49%, #00ff00 51%, transparent 51%),
                linear-gradient(45deg, transparent 49%, rgba(0, 255, 0, 0.4) 49%, rgba(0, 255, 0, 0.4) 51%, transparent 51%),
                linear-gradient(-45deg, transparent 49%, rgba(0, 255, 0, 0.4) 49%, rgba(0, 255, 0, 0.4) 51%, transparent 51%);
            border-radius: 50%;
            opacity: 0.7;
            pointer-events: none;
        }

        #fireDial::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            box-shadow: 0 0 10px #00ff00;
            pointer-events: none;
        }

        #fireDial:active {
            box-shadow: 
                inset 0 0 30px rgba(0, 255, 0, 0.5),
                0 0 25px #00ff00;
        }

        .action-buttons {
            position: absolute;
            right: 35px;
            top: 30px;
            width: 110px;
            height: 110px;
        }

        .action-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #000;
            border: 3px solid #ff00ff;
            color: #ff00ff;
            font-size: 8px;
            font-family: 'Press Start 2P';
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            user-select: none;
            touch-action: none;
            box-shadow: inset 0 0 10px #ff00ff, 0 0 10px #ff00ff;
            z-index: 100;
            cursor: pointer;
        }

        .action-btn:active {
            background: #ff00ff;
            color: #000;
            box-shadow: inset 0 0 20px #000, 0 0 20px #ff00ff;
        }

        #btnJetpack {
            top: 0;
            right: 0;
        }

        #btnJump {
            bottom: 0;
            right: 0;
        }

        /* End Screen */
        #endScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #00ff00;
            text-align: center;
            padding: 20px;
        }

        #endScreen.active {
            display: flex;
        }

        #endScreen h1 {
            font-size: 24px;
            margin-bottom: 40px;
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
        }

        #endScreen .stats {
            font-size: 10px;
            line-height: 2;
            margin-bottom: 40px;
            text-align: left;
            max-width: 300px;
        }

        #endTips {
            font-size: 9px;
            line-height: 1.8;
            margin-bottom: 30px;
            text-align: center;
            color: #ffff00;
        }

        .end-buttons {
            display: flex;
            gap: 20px;
        }

        #refreshButton, #meetCastButton {
            font-family: 'Press Start 2P';
            font-size: 14px;
            padding: 15px 30px;
            background: #00ff00;
            color: #000;
            border: 3px solid #ff00ff;
            cursor: pointer;
            box-shadow: 0 0 20px #00ff00;
        }

        #refreshButton:active {
            transform: scale(0.95);
        }

        /* Meet the Cast Screen */
        #castScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: none;
            overflow-y: auto;
            padding: 20px;
            color: #00ff00;
        }

        #castScreen.active {
            display: block;
        }

        .cast-header {
            text-align: center;
            font-size: 20px;
            color: #ff00ff;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #ff00ff;
        }

        .cast-member {
            margin-bottom: 40px;
            padding: 20px;
            border: 3px solid #00ff00;
            background: rgba(0, 255, 0, 0.05);
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .cast-member img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            image-rendering: pixelated;
            border: 2px solid #00ff00;
            background: #000;
            flex-shrink: 0;
        }

        .cast-member-text {
            flex: 1;
        }

        .cast-member h2 {
            font-size: 14px;
            color: #ffff00;
            margin-bottom: 15px;
        }

        .cast-member p {
            font-size: 10px;
            line-height: 1.8;
            color: #00ff00;
        }

        #closeCastButton {
            font-family: 'Press Start 2P';
            font-size: 14px;
            padding: 15px 30px;
            background: #ff00ff;
            color: #000;
            border: 3px solid #00ff00;
            cursor: pointer;
            box-shadow: 0 0 20px #ff00ff;
            display: block;
            margin: 30px auto;
        }

        #closeCastButton:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Title Screen -->
    <div id="titleScreen">
        <div id="logoContainer">
            <img id="logo" src="" alt="Chonx: 2025">
        </div>
        <button id="startButton">START GAME</button>
        <div id="legalFooter">
            <p>&copy; 2025 Neon Bread. All rights reserved.</p>
            <p>Chonx '25: The Rise of Brayn Wraught and its characters are owned by Neon Bread Studios.</p>
            <p>No affiliation or endorsement implied.</p>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- Left Control Panel -->
    <div id="leftControls">
        <div class="dpad">
            <div class="dpad-btn" id="btnLeft">◄</div>
            <div class="dpad-btn" id="btnRight">►</div>
            <div class="dpad-btn" id="btnUp">▲</div>
            <div class="dpad-btn" id="btnDown">▼</div>
        </div>
    </div>

    <!-- Right Control Panel -->
    <div id="rightControls">
        <div id="fireDial"></div>
        <div class="action-buttons">
            <div class="action-btn" id="btnJetpack">JET</div>
            <div class="action-btn" id="btnJump">JUMP</div>
        </div>
    </div>

    <!-- End Screen -->
    <div id="endScreen">
        <h1 id="endTitle">THE FEED IS STABLE<br>(FOR NOW)</h1>
        <div class="stats" id="endStats"></div>
        <div id="endTips">TIP: Hold shooting to charge your shot</div>
        <div class="end-buttons">
            <button id="refreshButton">REMATCH</button>
            <button id="meetCastButton">MEET THE CAST</button>
        </div>
    </div>

    <!-- Meet the Cast Screen -->
    <div id="castScreen">
        <h1 class="cast-header">MEET THE CAST</h1>
        
        <div class="cast-member">
            <img id="castChonx" src="" alt="Chonx">
            <div class="cast-member-text">
                <h2>CHONX THE SPACE HAMSTER</h2>
                <p>The one and only (to his knowledge) surviver of the 2025 assault of Brayn Wraught and his army. Chonx was just your average, everyday hamster with a job and a family, until Brayn turned them into 6-7 Rats. Now Chonx is out for revenge!</p>
            </div>
        </div>

        <div class="cast-member">
            <img id="castKhakipi" src="" alt="Khakipi">
            <div class="cast-member-text">
                <h2>KHAKIPI</h2>
                <p>Everybody knows pants are bullshit. Especially khankis. But now they're fighting back and Brayn Wraught has found a way to control them.</p>
            </div>
        </div>

        <div class="cast-member">
            <img id="castTurdal" src="" alt="Turdal">
            <div class="cast-member-text">
                <h2>TURDALS</h2>
                <p>If you've ever flushed a pet turtle, you're on the Turdals' list. (There are worse lists to be on.) Brayn channels these corrupt former pets as his first ground offense.</p>
            </div>
        </div>

        <div class="cast-member">
            <img id="castCloudTwerker" src="" alt="Cloud Twerker">
            <div class="cast-member-text">
                <h2>CLOUD TWERKERS</h2>
                <p>Graceful yet deadly, their pics are definitely filtered! Swipe left before they douse you in their toxic traits.</p>
            </div>
        </div>

        <div class="cast-member">
            <img id="castRat" src="" alt="6-7 Rat">
            <div class="cast-member-text">
                <h2>THE 6-7 RATS</h2>
                <p>What do you get when Brayn Wraught captures a critter and devours its brains? These nightmarish rats whose chant is almost as haunting as their eyes. There's no cure for Brayn's brand of zombification….except death.</p>
            </div>
        </div>

        <div class="cast-member">
            <img id="castBrayn" src="" alt="Brayn Wraught">
            <div class="cast-member-text">
                <h2>BRAYN WRAUGHT</h2>
                <p>The King of Soshelmeedya, an underworld where he keeps the brains of his victims. His favorite food is critter brains.</p>
            </div>
        </div>

        <button id="closeCastButton">BACK</button>
    </div>

    <script>
        // ===============================================
        // ASSET CONFIGURATION
        // ===============================================
        const ASSET_BASE_URL = "https://raw.githubusercontent.com/LogicNerds/chonx2025/main/";

        const ASSETS = {
            images: {
                background: ASSET_BASE_URL + "assets/background.jpg",
                logo: ASSET_BASE_URL + "assets/chonx25%20logo.png"
            },
            sprites: {
                chonxStand: ASSET_BASE_URL + "assets/Chonx standing.png",
                chonxRun: ASSET_BASE_URL + "assets/Chonx run gait.png",
                turdal: ASSET_BASE_URL + "assets/Turdal.png",
                cloudTwerker: ASSET_BASE_URL + "assets/Cloud Twerker.png",
                khakipi: ASSET_BASE_URL + "assets/Khakipus.png",
                rat1: ASSET_BASE_URL + "assets/SixSeven Rat 1.png",
                rat2: ASSET_BASE_URL + "assets/SixSeven Rat 2.png",
                braynStand: ASSET_BASE_URL + "assets/brayn wraught standing.png",
                braynSpit: ASSET_BASE_URL + "assets/brayn wraught spitting.png"
            },
            audio: {
                bgMusic: ASSET_BASE_URL + "assets/Chonx's%20Quest.mp3",
                bruvBruh: ASSET_BASE_URL + "assets/Bruh.m4a",
                ratsSixSeven: ASSET_BASE_URL + "assets/SixSevenChonx.mp3",
                chipShoot: ASSET_BASE_URL + "assets/chip_shoot.mp3",
                chipJump: ASSET_BASE_URL + "assets/chip_jump.mp3",
                chipJetpack: ASSET_BASE_URL + "assets/chip_jetpack.mp3",
                chipHit: ASSET_BASE_URL + "assets/chip_hit.mp3",
                chipCharge: ASSET_BASE_URL + "assets/chip_charge.mp3"
            }
        };

        // ===============================================
        // CANVAS SETUP - LANDSCAPE
        // ===============================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const BASE_WIDTH = 667;  // Swapped from 375
        const BASE_HEIGHT = 375; // Swapped from 667

        canvas.width = BASE_WIDTH;
        canvas.height = BASE_HEIGHT;

        let scale = 1;
        const HUD_HEIGHT = 50; // Reduced for landscape
        const ARENA_HEIGHT = BASE_HEIGHT - HUD_HEIGHT;
        const GROUND_Y = HUD_HEIGHT + ARENA_HEIGHT - 50;

        // ===============================================
        // GAMEPAD SUPPORT
        // ===============================================
        let gamepadIndex = null;
        let gamepadState = {
            leftStickX: 0,
            leftStickY: 0,
            rightStickX: 0,
            rightStickY: 0,
            buttonA: false,
            buttonB: false,
            buttonX: false,
            buttonY: false,
            dpadUp: false,
            dpadDown: false,
            dpadLeft: false,
            dpadRight: false,
            shoulderL: false,
            shoulderR: false,
            triggerL: false,
            triggerR: false
        };

        window.addEventListener('gamepadconnected', (e) => {
            console.log('Gamepad connected:', e.gamepad.id);
            gamepadIndex = e.gamepad.index;
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('Gamepad disconnected');
            if (gamepadIndex === e.gamepad.index) {
                gamepadIndex = null;
            }
        });

        function updateGamepad() {
            if (gamepadIndex === null) return;

            const gamepads = navigator.getGamepads();
            const gamepad = gamepads[gamepadIndex];
            
            if (!gamepad) return;

            // Left stick (movement)
            gamepadState.leftStickX = Math.abs(gamepad.axes[0]) > 0.2 ? gamepad.axes[0] : 0;
            gamepadState.leftStickY = Math.abs(gamepad.axes[1]) > 0.2 ? gamepad.axes[1] : 0;

            // Right stick (aiming)
            gamepadState.rightStickX = Math.abs(gamepad.axes[2]) > 0.2 ? gamepad.axes[2] : 0;
            gamepadState.rightStickY = Math.abs(gamepad.axes[3]) > 0.2 ? gamepad.axes[3] : 0;

            // Buttons (standard mapping)
            gamepadState.buttonA = gamepad.buttons[0]?.pressed || false; // Jump
            gamepadState.buttonB = gamepad.buttons[1]?.pressed || false;
            gamepadState.buttonX = gamepad.buttons[2]?.pressed || false;
            gamepadState.buttonY = gamepad.buttons[3]?.pressed || false;

            // Shoulders and triggers
            gamepadState.shoulderL = gamepad.buttons[4]?.pressed || false;
            gamepadState.shoulderR = gamepad.buttons[5]?.pressed || false;
            gamepadState.triggerL = gamepad.buttons[6]?.pressed || false; // Jetpack
            gamepadState.triggerR = gamepad.buttons[7]?.pressed || false; // Shoot

            // D-pad
            gamepadState.dpadUp = gamepad.buttons[12]?.pressed || false;
            gamepadState.dpadDown = gamepad.buttons[13]?.pressed || false;
            gamepadState.dpadLeft = gamepad.buttons[14]?.pressed || false;
            gamepadState.dpadRight = gamepad.buttons[15]?.pressed || false;

            // Apply to game controls
            if (gameState === 'playing') {
                // Movement from left stick or d-pad
                if (Math.abs(gamepadState.leftStickX) > 0.2) {
                    if (gamepadState.leftStickX < 0) {
                        keys.left = true;
                        keys.right = false;
                    } else {
                        keys.right = true;
                        keys.left = false;
                    }
                } else if (gamepadState.dpadLeft) {
                    keys.left = true;
                    keys.right = false;
                } else if (gamepadState.dpadRight) {
                    keys.right = true;
                    keys.left = false;
                } else {
                    keys.left = false;
                    keys.right = false;
                }

                // Vertical movement
                keys.up = gamepadState.dpadUp || gamepadState.leftStickY < -0.2;
                keys.down = gamepadState.dpadDown || gamepadState.leftStickY > 0.2;

                // Right stick shooting
                if (Math.abs(gamepadState.rightStickX) > 0.3 || Math.abs(gamepadState.rightStickY) > 0.3) {
                    const angle = Math.atan2(gamepadState.rightStickY, gamepadState.rightStickX);
                    if (!gamepadLastShot || Date.now() - gamepadLastShot > 200) {
                        shootProjectileAtAngle(angle, false);
                        gamepadLastShot = Date.now();
                    }
                }

                // Right trigger for charged shot
                if (gamepadState.triggerR && !gamepadCharging) {
                    gamepadCharging = true;
                    gamepadChargeStart = Date.now();
                    playSound('chipCharge', 0.2);
                } else if (!gamepadState.triggerR && gamepadCharging) {
                    gamepadCharging = false;
                    if (sounds.chipCharge) sounds.chipCharge.pause();
                    
                    const chargeDuration = (Date.now() - gamepadChargeStart) / 1000;
                    const isCharged = chargeDuration > 0.3;
                    
                    if (isCharged) {
                        stats.chargeShotsUsed++;
                    }
                    
                    // Shoot forward if no right stick input
                    const angle = Math.abs(gamepadState.rightStickX) > 0.3 || Math.abs(gamepadState.rightStickY) > 0.3
                        ? Math.atan2(gamepadState.rightStickY, gamepadState.rightStickX)
                        : 0; // Default to right
                    
                    shootProjectileAtAngle(angle, isCharged);
                }
            }
        }

        let gamepadLastShot = 0;
        let gamepadCharging = false;
        let gamepadChargeStart = 0;

        // ===============================================
        // ASSET LOADING
        // ===============================================
        const sprites = {};
        const sounds = {};
        let imagesLoaded = 0;
        let totalImages = 0;

        function loadAssets(callback) {
            totalImages = Object.keys(ASSETS.sprites).length + Object.keys(ASSETS.images).length - 1;

            sprites.background = new Image();
            sprites.background.onload = () => {
                imagesLoaded++;
                checkAssetsLoaded(callback);
            };
            sprites.background.onerror = () => {
                console.log('Background image failed to load');
                imagesLoaded++;
                checkAssetsLoaded(callback);
            };
            sprites.background.src = ASSETS.images.background;

            Object.keys(ASSETS.sprites).forEach(key => {
                sprites[key] = new Image();
                sprites[key].onload = () => {
                    imagesLoaded++;
                    checkAssetsLoaded(callback);
                };
                sprites[key].onerror = () => {
                    console.log(`Sprite ${key} failed to load`);
                    imagesLoaded++;
                    checkAssetsLoaded(callback);
                };
                sprites[key].src = ASSETS.sprites[key];
            });

            Object.keys(ASSETS.audio).forEach(key => {
                try {
                    sounds[key] = new Audio(ASSETS.audio[key]);
                    sounds[key].onerror = () => {
                        console.log(`Audio ${key} failed to load`);
                    };
                } catch (e) {
                    console.log(`Audio ${key} failed to initialize`);
                }
            });

            if (sounds.bgMusic) {
                sounds.bgMusic.loop = true;
                sounds.bgMusic.volume = 0.4;
            }
            if (sounds.chipJetpack) sounds.chipJetpack.loop = true;
            if (sounds.chipCharge) sounds.chipCharge.loop = true;
            if (sounds.ratsSixSeven) {
                sounds.ratsSixSeven.loop = true;
                sounds.ratsSixSeven.volume = 0.4;
            }
        }

        function checkAssetsLoaded(callback) {
            if (imagesLoaded >= totalImages) {
                console.log('All assets loaded!');
                callback();
            }
        }

        // ===============================================
        // AUDIO SYSTEM
        // ===============================================
        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Web Audio not supported');
                }
            }
        }

        function playSound(soundKey, volume = 0.5) {
            if (sounds[soundKey]) {
                try {
                    sounds[soundKey].currentTime = 0;
                    sounds[soundKey].volume = volume;
                    sounds[soundKey].play().catch(e => {
                        playBeep(soundKey, volume);
                    });
                } catch (e) {
                    playBeep(soundKey, volume);
                }
            } else {
                playBeep(soundKey, volume);
            }
        }

        function playBeep(soundKey, volume) {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                gainNode.gain.value = volume * 0.5;
                
                let duration = 0.1;
                
                if (soundKey === 'chipShoot') {
                    oscillator.frequency.value = 880;
                    oscillator.type = 'square';
                    duration = 0.08;
                } else if (soundKey === 'chipJump') {
                    oscillator.frequency.value = 440;
                    oscillator.type = 'square';
                    duration = 0.12;
                } else if (soundKey === 'chipHit') {
                    oscillator.frequency.value = 150;
                    oscillator.type = 'sawtooth';
                    duration = 0.1;
                } else if (soundKey === 'chipJetpack') {
                    oscillator.frequency.value = 300;
                    oscillator.type = 'triangle';
                    duration = 0.15;
                } else if (soundKey === 'chipCharge') {
                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';
                    duration = 0.2;
                }
                
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Beep error:', e);
            }
        }

        // ===============================================
        // GAME STATE
        // ===============================================
        let gameState = 'title';
        let currentWave = 0;
        let score = 0;
        let jetpackUnlocked = false;

        let stats = {
            enemiesKilled: 0,
            chargeShotsUsed: 0,
            jetpackActivations: 0,
            startTime: 0
        };

        // ===============================================
        // PLAYER STATE
        // ===============================================
        const player = {
            x: 50,
            y: GROUND_Y - 60,
            width: 40,
            height: 60,
            velocityX: 0,
            velocityY: 0,
            speed: 3,
            jumpPower: -12,
            gravity: 0.5,
            isGrounded: true,
            isJumping: false,
            health: 100,
            jetpackEnergy: 100,
            jetpackActive: false,
            animFrame: 0,
            animTimer: 0,
            facing: 1
        };

        // ===============================================
        // SHOOTING STATE
        // ===============================================
        const projectiles = [];

        // ===============================================
        // ENEMIES
        // ===============================================
        const enemies = [];
        let waveEnemiesSpawned = 0;
        let waveEnemiesTotal = 0;
        let spawnTimer = 0;
        let boss = null;
        let bossPhase = 1;
        let ratChantPlaying = false;

        // ===============================================
        // BACKGROUND SCROLLING
        // ===============================================
        let bgX1 = 0;
        let bgX2 = BASE_WIDTH;
        const bgScrollSpeed = 0.3;

        // ===============================================
        // INPUT HANDLING
        // ===============================================
        const keys = {
            left: false,
            right: false,
            up: false,
            down: false,
            jump: false,
            jetpack: false
        };

        function setupControls() {
            // D-pad
            const btnLeft = document.getElementById('btnLeft');
            const btnRight = document.getElementById('btnRight');
            const btnUp = document.getElementById('btnUp');
            const btnDown = document.getElementById('btnDown');
            const btnJump = document.getElementById('btnJump');
            const btnJetpack = document.getElementById('btnJetpack');

            // Touch events for buttons
            btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); keys.left = true; });
            btnLeft.addEventListener('touchend', (e) => { e.preventDefault(); keys.left = false; });
            btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); keys.right = true; });
            btnRight.addEventListener('touchend', (e) => { e.preventDefault(); keys.right = false; });
            btnUp.addEventListener('touchstart', (e) => { e.preventDefault(); keys.up = true; });
            btnUp.addEventListener('touchend', (e) => { e.preventDefault(); keys.up = false; });
            btnDown.addEventListener('touchstart', (e) => { e.preventDefault(); keys.down = true; });
            btnDown.addEventListener('touchend', (e) => { e.preventDefault(); keys.down = false; });
            
            btnJump.addEventListener('touchstart', (e) => { 
                e.preventDefault(); 
                if (player.isGrounded && !player.isJumping) {
                    player.velocityY = player.jumpPower;
                    player.isJumping = true;
                    player.isGrounded = false;
                    playSound('chipJump', 0.3);
                }
            });

            btnJetpack.addEventListener('touchstart', (e) => { 
                e.preventDefault();
                if (jetpackUnlocked && player.jetpackEnergy > 0) {
                    player.jetpackActive = !player.jetpackActive;
                    
                    if (player.jetpackActive) {
                        stats.jetpackActivations++;
                        playSound('chipJetpack', 0.3);
                        player.isGrounded = false;
                        player.velocityY = -8;
                    }
                }
            });

            btnJetpack.addEventListener('click', (e) => { 
                e.preventDefault();
                if (jetpackUnlocked && player.jetpackEnergy > 0) {
                    player.jetpackActive = !player.jetpackActive;
                    
                    if (player.jetpackActive) {
                        stats.jetpackActivations++;
                        playSound('chipJetpack', 0.3);
                        player.isGrounded = false;
                        player.velocityY = -8;
                    }
                }
            });

            // Keyboard - WASD + Space/Shift
            window.addEventListener('keydown', (e) => {
                if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') keys.left = true;
                if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') keys.right = true;
                if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') keys.up = true;
                if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') keys.down = true;
                
                // Spacebar for jump
                if (e.key === ' ' && player.isGrounded && !player.isJumping) {
                    player.velocityY = player.jumpPower;
                    player.isJumping = true;
                    player.isGrounded = false;
                    playSound('chipJump', 0.3);
                }
                
                // Shift for jetpack
                if ((e.key === 'Shift' || e.key === 'Control') && jetpackUnlocked && player.jetpackEnergy > 0) {
                    player.jetpackActive = !player.jetpackActive;
                    
                    if (player.jetpackActive) {
                        stats.jetpackActivations++;
                        playSound('chipJetpack', 0.3);
                        player.isGrounded = false;
                        player.velocityY = -8;
                    }
                }
            });

            window.addEventListener('keyup', (e) => {
                if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') keys.left = false;
                if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') keys.right = false;
                if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') keys.up = false;
                if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') keys.down = false;
            });

            // Mouse click for shooting
            canvas.addEventListener('click', (e) => {
                if (gameState !== 'playing') return;
                
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                const clickX = (e.clientX - rect.left) * scaleX;
                const clickY = (e.clientY - rect.top) * scaleY;
                
                const dx = clickX - (player.x + player.width / 2);
                const dy = clickY - (player.y + player.height / 2);
                const angle = Math.atan2(dy, dx);
                
                shootProjectileAtAngle(angle, false);
            });

            // Fire Dial - touch/mouse
            const fireDial = document.getElementById('fireDial');
            let dialCharging = false;
            let dialChargeStart = 0;

            fireDial.addEventListener('touchstart', handleDialStart);
            fireDial.addEventListener('mousedown', handleDialStart);
            fireDial.addEventListener('touchend', handleDialEnd);
            fireDial.addEventListener('mouseup', handleDialEnd);
            
            function handleDialStart(e) {
                e.preventDefault();
                dialCharging = true;
                dialChargeStart = Date.now();
                playSound('chipCharge', 0.2);
            }
            
            function handleDialEnd(e) {
                e.preventDefault();
                if (!dialCharging) return;
                
                dialCharging = false;
                if (sounds.chipCharge) sounds.chipCharge.pause();
                
                const rect = fireDial.getBoundingClientRect();
                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const dx = clientX - centerX;
                const dy = clientY - centerY;
                const angle = Math.atan2(dy, dx);
                
                const chargeDuration = (Date.now() - dialChargeStart) / 1000;
                const isCharged = chargeDuration > 0.3;
                
                if (isCharged) {
                    stats.chargeShotsUsed++;
                }
                
                shootProjectileAtAngle(angle, isCharged);
            }
        }

        function shootProjectileAtAngle(angle, isCharged) {
            const speed = 8;
            
            projectiles.push({
                x: player.x + player.width / 2,
                y: player.y + player.height / 2,
                velocityX: Math.cos(angle) * speed,
                velocityY: Math.sin(angle) * speed,
                damage: isCharged ? 3 : 1,
                radius: isCharged ? 8 : 4,
                isCharged: isCharged
            });
            
            playSound('chipShoot', 0.3);
        }

        // ===============================================
        // WAVE MANAGEMENT
        // ===============================================
        function startWave(waveNum) {
            currentWave = waveNum;
            enemies.length = 0;
            waveEnemiesSpawned = 0;
            spawnTimer = 0;

            if (waveNum === 1) {
                waveEnemiesTotal = 999;
            } else if (waveNum === 2) {
                waveEnemiesTotal = 40;
            } else if (waveNum === 3) {
                waveEnemiesTotal = 67;
            } else if (waveNum === 4) {
                spawnBoss();
            }
        }

        function updateWaveSpawning() {
            if (currentWave === 4) return;
            
            if (currentWave === 1) {
                spawnTimer++;
                if (spawnTimer >= 50) {
                    spawnTimer = 0;
                    spawnEnemy();
                }
                return;
            }
            
            if (waveEnemiesSpawned >= waveEnemiesTotal) return;

            spawnTimer++;
            
            let spawnRate = 60;
            if (currentWave === 2) spawnRate = 45;
            if (currentWave === 3) spawnRate = 20;

            if (spawnTimer >= spawnRate) {
                spawnTimer = 0;
                spawnEnemy();
            }
        }

        function spawnEnemy() {
            waveEnemiesSpawned++;

            if (currentWave === 1) {
                enemies.push({
                    type: 'khakipi',
                    x: BASE_WIDTH + 50,
                    y: GROUND_Y - 62,
                    width: 62,
                    height: 62,
                    velocityX: -2,
                    velocityY: 0,
                    health: 2,
                    burstTimer: 30,
                    onGround: true,
                    points: 4
                });
            } else if (currentWave === 2) {
                if (Math.random() < 0.5) {
                    enemies.push({
                        type: 'turdal',
                        x: BASE_WIDTH + 50,
                        y: GROUND_Y - 30,
                        width: 30,
                        height: 30,
                        velocityX: -1.5,
                        velocityY: 0,
                        health: 3,
                        shootTimer: Math.random() * 60 + 60,
                        shootCooldown: 120,
                        points: 2
                    });
                } else {
                    // Cloud Twerker - floating acid dropper
                    const minY = HUD_HEIGHT + 60; // Well above HUD
                    const maxY = GROUND_Y - 120; // Well above ground
                    const spawnY = minY + Math.random() * (maxY - minY);
                    
                    enemies.push({
                        type: 'cloudTwerker',
                        x: BASE_WIDTH + 50,
                        y: spawnY,
                        baseY: spawnY, // Store base Y for bobbing
                        width: 40,
                        height: 40,
                        velocityX: -0.8,
                        velocityY: 0,
                        health: 2,
                        floatPhase: Math.random() * Math.PI * 2,
                        dropTimer: Math.random() * 90 + 60,
                        points: 2
                    });
                }
            } else if (currentWave === 3) {
                const speedType = Math.random();
                let speed, jumpPower, jumpFrequency;
                
                if (speedType < 0.2) {
                    speed = -0.8;
                    jumpPower = 0;
                    jumpFrequency = 0;
                } else if (speedType < 0.4) {
                    speed = -1.2;
                    jumpPower = -5;
                    jumpFrequency = 80 + Math.random() * 40;
                } else if (speedType < 0.7) {
                    speed = -2;
                    jumpPower = -8;
                    jumpFrequency = 50 + Math.random() * 30;
                } else {
                    speed = -3.5;
                    jumpPower = -12;
                    jumpFrequency = 30 + Math.random() * 20;
                }
                
                enemies.push({
                    type: 'rat',
                    x: BASE_WIDTH + 50,
                    y: GROUND_Y - 40,
                    width: 40,
                    height: 40,
                    velocityX: speed,
                    velocityY: 0,
                    health: 1,
                    animFrame: 0,
                    animTimer: 0,
                    canJump: jumpPower !== 0,
                    jumpPower: jumpPower,
                    jumpTimer: jumpFrequency,
                    jumpFrequency: jumpFrequency,
                    onGround: true,
                    points: 1
                });
                
                if (!ratChantPlaying && sounds.ratsSixSeven) {
                    sounds.ratsSixSeven.currentTime = 0;
                    sounds.ratsSixSeven.play().catch(e => console.log('Rat chant blocked'));
                    ratChantPlaying = true;
                }
            }
        }

        function spawnBoss() {
            boss = {
                x: BASE_WIDTH - 150,
                y: GROUND_Y - 120,
                width: 100,
                height: 120,
                velocityX: 0,
                velocityY: 0,
                health: 67,
                maxHealth: 67,
                shootTimer: 30,
                shootCooldown: 45,
                isShooting: false,
                shootAnimTimer: 0,
                ratSpawnTimer: 0,
                hopTimer: 90,
                isGrounded: true
            };
        }

        // ===============================================
        // UPDATE LOOP
        // ===============================================
        function update() {
            if (gameState !== 'playing') return;

            // Update gamepad
            updateGamepad();

            bgX1 -= bgScrollSpeed;
            bgX2 -= bgScrollSpeed;

            if (bgX1 <= -BASE_WIDTH) bgX1 = bgX2 + BASE_WIDTH;
            if (bgX2 <= -BASE_WIDTH) bgX2 = bgX1 + BASE_WIDTH;

            if (keys.left) {
                player.velocityX = -player.speed;
                player.facing = -1;
            } else if (keys.right) {
                player.velocityX = player.speed;
                player.facing = 1;
            } else {
                player.velocityX *= 0.8;
            }

            if (player.jetpackActive && jetpackUnlocked) {
                if (player.jetpackEnergy > 0) {
                    player.jetpackEnergy -= 0.2;
                    
                    player.velocityY = 0;
                    
                    if (keys.up) {
                        player.velocityY = -3;
                    } else if (keys.down) {
                        player.velocityY = 3;
                    }
                } else {
                    player.jetpackActive = false;
                    player.jetpackEnergy = 0;
                }
            } else {
                if (!player.isGrounded) {
                    player.velocityY += player.gravity;
                }
            }

            player.x += player.velocityX;
            player.y += player.velocityY;

            if (player.x < 0) player.x = 0;
            if (player.x > BASE_WIDTH - player.width) player.x = BASE_WIDTH - player.width;

            if (player.y >= GROUND_Y - player.height) {
                player.y = GROUND_Y - player.height;
                player.velocityY = 0;
                player.isGrounded = true;
                player.isJumping = false;
            } else {
                player.isGrounded = false;
            }

            if (Math.abs(player.velocityX) > 0.5 && player.isGrounded) {
                player.animTimer++;
                if (player.animTimer > 12) {
                    player.animFrame = 1 - player.animFrame;
                    player.animTimer = 0;
                }
            } else {
                player.animFrame = 0;
            }

            for (let i = projectiles.length - 1; i >= 0; i--) {
                const p = projectiles[i];
                p.x += p.velocityX;
                p.y += p.velocityY;

                if (p.x < -20 || p.x > BASE_WIDTH + 20 || p.y < -20 || p.y > BASE_HEIGHT + 20) {
                    projectiles.splice(i, 1);
                }
            }

            updateEnemies();

            if (boss) {
                updateBoss();
            }

            updateWaveSpawning();

            if (currentWave === 1 && score >= 67 && !jetpackUnlocked) {
                jetpackUnlocked = true;
                player.jetpackEnergy = 100;
                startWave(2);
            } else if (currentWave === 2 && waveEnemiesSpawned >= waveEnemiesTotal && enemies.length === 0) {
                startWave(3);
            } else if (currentWave === 3 && waveEnemiesSpawned >= waveEnemiesTotal && enemies.length === 0) {
                startWave(4);
            }

            if (player.health <= 0) {
                endGame(false);
            }
        }

        function updateEnemies() {
            const ratsOnScreen = enemies.filter(e => e.type === 'rat').length;
            
            if (ratChantPlaying && ratsOnScreen === 0 && sounds.ratsSixSeven) {
                sounds.ratsSixSeven.pause();
                sounds.ratsSixSeven.currentTime = 0;
                ratChantPlaying = false;
            }
            
            for (let i = enemies.length - 1; i >= 0; i--) {
                const e = enemies[i];

                if (e.type === 'turdal') {
                    e.x += e.velocityX;
                    
                    e.shootTimer--;
                    if (e.shootTimer <= 0) {
                        e.shootTimer = e.shootCooldown;
                        spawnEnemyProjectile(e.x, e.y + e.height / 2, -5, 0);
                    }
                } else if (e.type === 'cloudTwerker') {
                    e.x += e.velocityX;
                    e.floatPhase += 0.05;
                    // Bob up and down around base Y (no continuous descent)
                    e.y = e.baseY + Math.sin(e.floatPhase) * 15; // ±15px bobbing range
                    
                    e.dropTimer--;
                    if (e.dropTimer <= 0) {
                        e.dropTimer = 90;
                        const numDrops = 3 + Math.floor(Math.random() * 3);
                        for (let i = 0; i < numDrops; i++) {
                            spawnEnemyProjectile(
                                e.x + (Math.random() - 0.5) * e.width,
                                e.y + e.height,
                                (Math.random() - 0.5) * 0.5,
                                3,
                                1,
                                2
                            );
                        }
                    }
                } else if (e.type === 'khakipi') {
                    e.x += e.velocityX;
                    
                    e.burstTimer--;
                    if (e.burstTimer <= 0) {
                        e.burstTimer = 30 + Math.random() * 20;
                        e.velocityX = -2 + (Math.random() - 0.5) * 2;
                        e.velocityY = (Math.random() - 0.5) * 4;
                        e.onGround = false;
                    }
                    
                    if (!e.onGround) {
                        e.y += e.velocityY;
                        if (e.y >= GROUND_Y - e.height) {
                            e.y = GROUND_Y - e.height;
                            e.velocityY = 0;
                            e.onGround = true;
                        }
                    }
                } else if (e.type === 'rat') {
                    e.x += e.velocityX;
                    
                    e.animTimer++;
                    if (e.animTimer > 15) {
                        e.animFrame = 1 - e.animFrame;
                        e.animTimer = 0;
                    }
                    
                    if (e.canJump && e.onGround) {
                        e.jumpTimer--;
                        if (e.jumpTimer <= 0) {
                            e.jumpTimer = e.jumpFrequency;
                            e.velocityY = e.jumpPower;
                            e.onGround = false;
                        }
                    }
                    
                    if (!e.onGround) {
                        e.velocityY += 0.5;
                        e.y += e.velocityY;
                        
                        if (e.y >= GROUND_Y - e.height) {
                            e.y = GROUND_Y - e.height;
                            e.velocityY = 0;
                            e.onGround = true;
                        }
                    }
                }

                if (checkCollision(player, e)) {
                    player.health -= 2;
                    playSound('chipHit', 0.4);
                    enemies.splice(i, 1);
                    continue;
                }

                for (let j = projectiles.length - 1; j >= 0; j--) {
                    const p = projectiles[j];
                    if (checkPointInRect(p.x, p.y, e)) {
                        e.health -= p.damage;
                        projectiles.splice(j, 1);
                        
                        if (e.health <= 0) {
                            stats.enemiesKilled++;
                            
                            score += e.points || 1;
                            
                            if (jetpackUnlocked) {
                                player.jetpackEnergy = Math.min(100, player.jetpackEnergy + 10);
                            }
                            
                            enemies.splice(i, 1);
                        }
                        break;
                    }
                }

                if (e.x < -100 || e.y > BASE_HEIGHT + 50) {
                    enemies.splice(i, 1);
                }
            }
        }

        const enemyProjectiles = [];

        function spawnEnemyProjectile(x, y, vx, vy, damage = 2, radius = 5) {
            enemyProjectiles.push({ x, y, velocityX: vx, velocityY: vy, radius, damage });
        }

        function updateBoss() {
            boss.hopTimer--;
            if (boss.hopTimer <= 0 && boss.isGrounded) {
                boss.hopTimer = 60 + Math.random() * 60;
                boss.velocityY = -8;
                boss.isGrounded = false;
                
                if (player.x < boss.x - 50) {
                    boss.velocityX = -1.5;
                } else if (player.x > boss.x + boss.width + 50) {
                    boss.velocityX = 1.5;
                } else {
                    boss.velocityX = 0;
                }
            }
            
            if (!boss.isGrounded) {
                boss.velocityY += 0.5;
                boss.y += boss.velocityY;
                
                if (boss.y >= GROUND_Y - boss.height) {
                    boss.y = GROUND_Y - boss.height;
                    boss.velocityY = 0;
                    boss.isGrounded = true;
                    boss.velocityX = 0;
                }
            }
            
            boss.x += boss.velocityX;
            
            if (boss.x < BASE_WIDTH / 2) boss.x = BASE_WIDTH / 2;
            if (boss.x > BASE_WIDTH - boss.width - 20) boss.x = BASE_WIDTH - boss.width - 20;
            
            boss.shootTimer--;
            
            if (boss.shootTimer <= 0) {
                boss.shootTimer = boss.shootCooldown;
                boss.isShooting = true;
                boss.shootAnimTimer = 20;
                
                const dx = player.x + player.width / 2 - boss.x;
                const dy = player.y + player.height / 2 - (boss.y + boss.height / 2);
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                spawnEnemyProjectile(
                    boss.x,
                    boss.y + boss.height / 2,
                    (dx / dist) * 5,
                    (dy / dist) * 5
                );
                
                playSound('bruvBruh', 0.5);
            }
            
            if (boss.shootAnimTimer > 0) {
                boss.shootAnimTimer--;
                if (boss.shootAnimTimer === 0) {
                    boss.isShooting = false;
                }
            }

            if (boss.health <= boss.maxHealth / 2 && bossPhase === 1) {
                bossPhase = 2;
                boss.shootCooldown = 30;
            }

            if (bossPhase === 2) {
                boss.ratSpawnTimer++;
                if (boss.ratSpawnTimer >= 180) {
                    boss.ratSpawnTimer = 0;
                    for (let i = 0; i < 7; i++) {
                        const speedType = Math.random();
                        let speed, jumpPower, jumpFrequency;
                        
                        if (speedType < 0.2) {
                            speed = -0.8;
                            jumpPower = 0;
                            jumpFrequency = 0;
                        } else if (speedType < 0.4) {
                            speed = -1.2;
                            jumpPower = -5;
                            jumpFrequency = 80 + Math.random() * 40;
                        } else if (speedType < 0.7) {
                            speed = -2;
                            jumpPower = -8;
                            jumpFrequency = 50 + Math.random() * 30;
                        } else {
                            speed = -3.5;
                            jumpPower = -12;
                            jumpFrequency = 30 + Math.random() * 20;
                        }
                        
                        enemies.push({
                            type: 'rat',
                            x: BASE_WIDTH + 50 + i * 50,
                            y: GROUND_Y - 40,
                            width: 40,
                            height: 40,
                            velocityX: speed,
                            velocityY: 0,
                            health: 1,
                            animFrame: 0,
                            animTimer: 0,
                            canJump: jumpPower !== 0,
                            jumpPower: jumpPower,
                            jumpTimer: jumpFrequency,
                            jumpFrequency: jumpFrequency,
                            onGround: true,
                            points: 1
                        });
                    }
                    
                    if (!ratChantPlaying && sounds.ratsSixSeven) {
                        sounds.ratsSixSeven.currentTime = 0;
                        sounds.ratsSixSeven.play().catch(e => console.log('Rat chant blocked'));
                        ratChantPlaying = true;
                    }
                }
            }

            for (let j = projectiles.length - 1; j >= 0; j--) {
                const p = projectiles[j];
                if (checkPointInRect(p.x, p.y, boss)) {
                    boss.health -= p.damage;
                    projectiles.splice(j, 1);
                    
                    if (boss.health <= 0) {
                        boss = null;
                        endGame(true);
                    }
                }
            }
        }

        function updateEnemyProjectiles() {
            for (let i = enemyProjectiles.length - 1; i >= 0; i--) {
                const p = enemyProjectiles[i];
                p.x += p.velocityX;
                p.y += p.velocityY;

                const dx = p.x - (player.x + player.width / 2);
                const dy = p.y - (player.y + player.height / 2);
                if (Math.sqrt(dx * dx + dy * dy) < p.radius + 10) {
                    player.health -= p.damage;
                    playSound('chipHit', 0.4);
                    enemyProjectiles.splice(i, 1);
                    continue;
                }

                if (p.x < -20 || p.x > BASE_WIDTH + 20 || p.y < -20 || p.y > BASE_HEIGHT + 20) {
                    enemyProjectiles.splice(i, 1);
                }
            }
        }

        // ===============================================
        // COLLISION DETECTION
        // ===============================================
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        function checkPointInRect(x, y, rect) {
            return x >= rect.x && x <= rect.x + rect.width &&
                   y >= rect.y && y <= rect.y + rect.height;
        }

        // ===============================================
        // RENDER LOOP
        // ===============================================
        function render() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, BASE_WIDTH, BASE_HEIGHT);

            if (sprites.background && sprites.background.complete) {
                ctx.drawImage(sprites.background, bgX1, 0, BASE_WIDTH, BASE_HEIGHT);
                ctx.drawImage(sprites.background, bgX2, 0, BASE_WIDTH, BASE_HEIGHT);
            }

            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, GROUND_Y);
            ctx.lineTo(BASE_WIDTH, GROUND_Y);
            ctx.stroke();

            const playerSprite = player.animFrame === 0 ? sprites.chonxStand : sprites.chonxRun;
            if (playerSprite && playerSprite.complete) {
                ctx.save();
                if (player.facing === -1) {
                    ctx.translate(player.x + player.width, player.y);
                    ctx.scale(-1, 1);
                    ctx.drawImage(playerSprite, 0, 0, player.width, player.height);
                } else {
                    ctx.drawImage(playerSprite, player.x, player.y, player.width, player.height);
                }
                ctx.restore();
            } else {
                ctx.fillStyle = '#ff00ff';
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }

            enemies.forEach(e => {
                let sprite = null;
                if (e.type === 'turdal') sprite = sprites.turdal;
                else if (e.type === 'cloudTwerker') sprite = sprites.cloudTwerker;
                else if (e.type === 'khakipi') sprite = sprites.khakipi;
                else if (e.type === 'rat') sprite = e.animFrame === 0 ? sprites.rat1 : sprites.rat2;

                if (sprite && sprite.complete) {
                    ctx.drawImage(sprite, e.x, e.y, e.width, e.height);
                } else {
                    ctx.fillStyle = '#00ff00';
                    ctx.fillRect(e.x, e.y, e.width, e.height);
                }
            });

            if (boss) {
                const bossSprite = boss.isShooting ? sprites.braynSpit : sprites.braynStand;
                
                if (bossPhase === 2 && Math.floor(Date.now() / 200) % 2 === 0) {
                    ctx.globalAlpha = 0.7;
                }
                
                if (bossSprite && bossSprite.complete) {
                    ctx.save();
                    ctx.translate(boss.x + boss.width, boss.y);
                    ctx.scale(-1, 1);
                    ctx.drawImage(bossSprite, 0, 0, boss.width, boss.height);
                    ctx.restore();
                } else {
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(boss.x, boss.y, boss.width, boss.height);
                }
                
                ctx.globalAlpha = 1;

                const barWidth = 200;
                const barHeight = 20;
                const barX = (BASE_WIDTH - barWidth) / 2;
                const barY = HUD_HEIGHT + 20;
                
                ctx.fillStyle = '#000';
                ctx.fillRect(barX - 2, barY - 2, barWidth + 4, barHeight + 4);
                
                ctx.strokeStyle = '#ffff00';
                ctx.lineWidth = 3;
                ctx.strokeRect(barX - 2, barY - 2, barWidth + 4, barHeight + 4);
                
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(barX, barY, barWidth * (boss.health / boss.maxHealth), barHeight);
                
                ctx.fillStyle = '#ffff00';
                ctx.font = '8px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.fillText('BRAYN WRAUGHT', BASE_WIDTH / 2, barY - 8);
                ctx.textAlign = 'left';
            }

            projectiles.forEach(p => {
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.shadowBlur = 15;
                ctx.shadowColor = p.isCharged ? '#ffff00' : '#00ffff';
                ctx.fillStyle = p.isCharged ? '#ffff00' : '#00ffff';
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });

            enemyProjectiles.forEach(p => {
                if (p.radius === 2) {
                    ctx.fillStyle = '#00ff00';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = '#00ff00';
                    ctx.beginPath();
                    for (let i = 0; i < 8; i++) {
                        const angle = (i / 8) * Math.PI * 2;
                        const variation = 0.7 + Math.sin(Date.now() / 100 + i) * 0.3;
                        const radius = p.radius * variation;
                        const x = p.x + Math.cos(angle) * radius;
                        const y = p.y + Math.sin(angle) * radius;
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.closePath();
                    ctx.fill();
                }
            });

            drawHUD();
        }

        function drawHUD() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, BASE_WIDTH, HUD_HEIGHT);
            
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, BASE_WIDTH, HUD_HEIGHT);

            ctx.font = '10px "Press Start 2P"';
            
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(10, 10, 150, 15);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(10, 10, 150 * (player.health / 100), 15);
            ctx.fillStyle = '#fff';
            ctx.fillText('HP: ' + Math.max(0, Math.floor(player.health)) + '%', 15, 22);

            if (jetpackUnlocked) {
                ctx.fillStyle = '#333';
                ctx.fillRect(175, 10, 100, 15);
                ctx.fillStyle = '#00ffff';
                ctx.fillRect(175, 10, 100 * (player.jetpackEnergy / 100), 15);
                ctx.fillStyle = '#fff';
                ctx.fillText('JET: ' + Math.floor(player.jetpackEnergy) + '%', 180, 22);
            } else {
                ctx.fillStyle = '#666';
                ctx.fillText('JET: LOCKED', 180, 22);
            }

            ctx.fillStyle = '#fff';
            ctx.fillText('PTS: ' + score, BASE_WIDTH - 120, 22);

            ctx.fillText('WAVE: ' + currentWave, BASE_WIDTH - 120, 40);

            if (score >= 67 && !jetpackUnlocked) {
                ctx.fillStyle = '#ffff00';
                ctx.fillText('67!', BASE_WIDTH / 2 - 15, 40);
            }
        }

        // ===============================================
        // GAME LOOP
        // ===============================================
        function gameLoop() {
            update();
            updateEnemyProjectiles();
            render();
            requestAnimationFrame(gameLoop);
        }

        // ===============================================
        // RESIZE HANDLING
        // ===============================================
        function resizeCanvas() {
            scale = Math.min(
                window.innerWidth / BASE_WIDTH,
                window.innerHeight / BASE_HEIGHT
            );

            canvas.style.width = (BASE_WIDTH * scale) + 'px';
            canvas.style.height = (BASE_HEIGHT * scale) + 'px';
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ===============================================
        // GAME START
        // ===============================================
        function startGameplay() {
            document.getElementById('titleScreen').classList.add('hidden');
            document.getElementById('leftControls').classList.add('active');
            document.getElementById('rightControls').classList.add('active');
            
            gameState = 'playing';
            stats.startTime = Date.now();
            
            startWave(1);
            gameLoop();
        }

        // ===============================================
        // GAME END
        // ===============================================
        const tips = [
            "TIP: To activate the jet pack you must score 67 points",
            "TIP: The jet pack can only be turned on while jumping",
            "TIP: Hold shooting to charge your shot",
            "TIP: Kills = jet pack energy"
        ];
        let currentTipIndex = 0;
        let tipInterval = null;

        function endGame(isVictory) {
            gameState = 'ended';
            
            const playTime = Math.floor((Date.now() - stats.startTime) / 1000);
            
            const titleElement = document.getElementById('endTitle');
            if (isVictory) {
                titleElement.innerHTML = 'MAIN CHARACTER<br>ENERGY!';
            } else {
                titleElement.innerHTML = 'YOU FAILED! 🙄';
            }
            
            const statsHTML = `
                <p>Enemies Neutralized: ${stats.enemiesKilled}</p>
                <p>Charge Shots Used: ${stats.chargeShotsUsed}</p>
                <p>Jet Pack Activations: ${stats.jetpackActivations}</p>
                <p>Seconds of Attention Burned: ${playTime}</p>
            `;
            
            document.getElementById('endStats').innerHTML = statsHTML;
            
            const tipsElement = document.getElementById('endTips');
            if (isVictory) {
                tipsElement.style.display = 'none';
                if (tipInterval) clearInterval(tipInterval);
            } else {
                tipsElement.style.display = 'block';
                currentTipIndex = 0;
                tipsElement.textContent = tips[0];
                if (tipInterval) clearInterval(tipInterval);
                tipInterval = setInterval(() => {
                    currentTipIndex = (currentTipIndex + 1) % tips.length;
                    tipsElement.textContent = tips[currentTipIndex];
                }, 3000);
            }
            
            if (sounds.ratsSixSeven) {
                sounds.ratsSixSeven.pause();
                sounds.ratsSixSeven.currentTime = 0;
            }
            ratChantPlaying = false;
            
            document.getElementById('endScreen').classList.add('active');
        }

        document.getElementById('refreshButton').addEventListener('click', () => {
            location.reload();
        });

        document.getElementById('meetCastButton').addEventListener('click', () => {
            document.getElementById('endScreen').classList.remove('active');
            document.getElementById('castScreen').classList.add('active');
        });

        document.getElementById('closeCastButton').addEventListener('click', () => {
            document.getElementById('castScreen').classList.remove('active');
            document.getElementById('endScreen').classList.add('active');
        });

        // ===============================================
        // INITIALIZE
        // ===============================================
        
        document.getElementById('logo').src = ASSET_BASE_URL + "assets/chonx25%20logo.png";
        document.getElementById('castChonx').src = ASSETS.sprites.chonxStand;
        document.getElementById('castKhakipi').src = ASSETS.sprites.khakipi;
        document.getElementById('castTurdal').src = ASSETS.sprites.turdal;
        document.getElementById('castCloudTwerker').src = ASSETS.sprites.cloudTwerker;
        document.getElementById('castRat').src = ASSETS.sprites.rat1;
        document.getElementById('castBrayn').src = ASSETS.sprites.braynStand;
        
        document.getElementById('startButton').addEventListener('click', () => {
            document.getElementById('startButton').textContent = 'Loading...';
            initAudioContext();
            
            loadAssets(() => {
                if (sounds.bgMusic) {
                    sounds.bgMusic.currentTime = 0;
                    sounds.bgMusic.play().catch(e => console.log('Background music blocked'));
                }
                
                setupControls();
                startGameplay();
            });
        });
    </script>
</body>
</html>
